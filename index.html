<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<title>reveal.js</title>

	<link rel="stylesheet" href="dist/reset.css">
	<link rel="stylesheet" href="dist/reveal.css">
	<link rel="stylesheet" href="dist/theme/black.css">

	<!-- Theme used for syntax highlighted code -->
	<link rel="stylesheet" href="plugin/highlight/monokai.css">
</head>

<body>
	<div class="reveal">
		<div class="slides">
			<section>
				<h3 style="color:lightgreen">SQL Data Import Pipeline for</h3>
				<img src="img/arches.webp" alt="arches icon" width=40% height=40%>

				<br>
				<h4 style="font-size:60%">Presented By: Junaid Abdul Jabbar</h4>
				<img src="img/project_logos.png">


			</section>

			<section>
				<img src="img/mahsa.png" alt="arches icon" width=30% height=30%>
				<br>
				<ul style="text-align: left;font-size:60%">
					<li>Documentation of the endangered archaeology and cultural heritage of the Indus River Basin and
						surrounding areas using the Arches platform</li>
					<br>
					<li>Collaborative research output with development and training programmes</li>
					<br>
					<li>Started with Arches v5.1, currently on v7.5.0, upgrading to v7.6.0</li>
				</ul>
			</section>

			<section>
				<h4 style="color:lightgreen;font-weight:bold">Challenges</h4>
				<ul style="text-align: left;font-size:50%">
					<li>Complex site groups with location variations</li>
					<br>
					<img src="img/Map2.png" style="display: block; margin: 0 auto;" alt="Centered Image" width=50%
						height=50%>


				</ul>
			</section>


			<section>
				<h4 style="color:lightgreen;font-weight:bold">Challenges</h4>
				<ul style="text-align: left;font-size:50%">
					<li>Collaborative working in a GIS environment with multiple reference layers to compare attributes
						and geometry to collate data</li>
					<br>
					<img src="img/qgis_form.png" style="display: block; margin: 0 auto;" alt="Centered Image" width=75%
						height=75%>
				</ul>
			</section>

			<section>
				<h4 style="color:lightgreen;font-weight:bold">Challenges</h4>
				<ul style="text-align: left;font-size:50%">
					<li>Nested resource model and data import</li>
					<br>
					<img src="img/hl_rm.png" style="display: block; margin: 0 auto;" alt="Centered Image" width=50%
						height=50%>
				</ul>
			</section>

			<section>
				<h4 style="color:lightgreen;font-weight:bold">Nested Data Import Options</h4>
				<br>
				<ul style="text-align: left;font-size:50%">
					<li>JSON Import - primarily intended for transferring business data between arches instances.</li>
					<br>
					<li>SQL Import (v7) - much more flexible and faster than csv data import. Especially useful to
						migrate data from a SQL database into Arches.</li>
				</ul>
			</section>




			<section>
				<h4 style="color:lightgreen;font-weight:bold">Foreign Data Wrapper</h4>

				<ul style="text-align: left;font-size:50%">
					To prepare for remote access using postgres_fdw:

					<ul>
						<br>
						<li>Install the postgres_fdw extension with CREATE EXTENSION</li>
						<br>
						<li>Create a foreign server object using CREATE SERVER for each remote database, specifying
							connection information (excluding user and password) as options.</li>
						<br>
						<li>Create a user mapping with CREATE USER MAPPING for each database user allowed to access the
							foreign server, specifying remote username and password.</li>
						<br>
						<li>Create a foreign table using CREATE FOREIGN TABLE or IMPORT FOREIGN SCHEMA for each remote
							table, ensuring columns match the remote table. You can use different names if the correct
							remote names are specified as options.</li>
					</ul>
				</ul>
			</section>

			<section data-auto-animate>
				<h4 style="color:lightgreen;font-weight:bold">Create schema for resource models</h4>
				<li style="text-align: left;font-size:50%">Create schema for all published resource models</li>
				<pre>
						<code style="width: 600px; margin: 0 auto; display: block; font-size: 90%;">
							<script type="text/template";>SELECT __arches_create_resource_model_views(graphid)
FROM graphs
WHERE publicationid IS NOT NULL
AND isresource IS TRUE
AND name->>'en' != 'Arches System Settings';</script>
						</code>
					</pre>

				<li style="text-align: left;font-size:50%">Create schema for a particular resource model</li>
				<pre>
						<code style="width: 600px; margin: 0 auto; display: block; font-size: 90%;">
							<script type="text/template";>SELECT __arches_create_resource_model_views(graphid)
FROM graphs
WHERE publicationid IS NOT NULL
AND isresource IS TRUE
AND graphid = '8d765e70-b69b-11ed-8613-efcdc71353a1';</script>
						</code>
					</pre>
			</section>


			<section data-auto-animate>
				<h4 style="color:lightgreen;font-weight:bold">Resource Model Schema - Instances</h4>
				<li style="text-align: left;font-size:50%">Each resource model schema will have a view 'Instances'</li>
				<pre>
						<code style="width: 750px; margin: 0 auto; display: block; font-size: 90%;">
							<script type="text/template";>INSERT INTO heritage_location.instances (resourceinstanceid, legacyid)
SELECT uuid_value, mahsa_id
FROM ft_hl_resources;</script>
						</code>
					</pre>
			</section>

			<!--
			<section data-auto-animate>
				<h4 style="color:lightgreen;font-weight:bold">SQL Functions</h4>

				<pre>
						<code data-line-numbers="1|2|3|4|5">
							<script type="text/template";>__arches_create_nodegroup_view (group_id, view_name, schema_name, parent_name)
__arches_create_branch_views (group_id, schema_name)
__arches_create_resource_model_views (model_id, schema_name)
__arches_get_node_id_for_view_column (schema_name,view_name,column_name)
__arches_get_labels_for_concept_node (node_id, language_id)
							</script>
						</code>
					</pre>
			</section>
-->
			<section data-auto-animate>
				<h4 style="color:lightgreen;font-weight:bold">Arches String - PostgreSQL JSONB</h4>
				<pre>
						<code style="width: 300px; margin: 0 auto; display: block;">
							<script type="text/template">{
	"en":{
		"value":"Anbar Well",
		"direction":"ltr"
	}
}
</script>
</code>
</pre>
			</section>

			<section data-auto-animate>
				<h4 style="color:lightgreen;font-weight:bold">Arches String - PostgreSQL JSONB</h4>
				<pre>
			<code style="width: 300px; margin: 0 auto; display: block;">
				<script type="text/template">{
	"en":{
		"value":"Anbar Well",
		"direction":"ltr"
	},
	"hi":{
		"value":"अनबर खैर",
		"direction":"ltr"
	},
	"ur":{
		"value":"عنبر ویل",
		"direction":"rtl"
	}
}
</script>
</code>
</pre>
			</section>

			<section data-auto-animate>
				<h4 style="color:lightgreen;font-weight:bold">Arches String - PostgreSQL JSONB</h4>
				<pre>
			<code style="width: 1050px; margin: 0 auto; display: block; margin-left: -50px; font-size: 90%;">
				<script type="text/template">CREATE OR REPLACE FUNCTION build_lang_json(text_value TEXT, lang_code TEXT)
RETURNS JSONB AS $$
BEGIN
-- Return NULL if text_value is NULL
IF text_value IS NULL THEN
RETURN NULL;
END IF;

RETURN jsonb_build_object(
'en', jsonb_build_object('value', CASE WHEN lang_code = 'en' THEN text_value ELSE '' END, 'direction', 'ltr'),
'ur', jsonb_build_object('value', CASE WHEN lang_code = 'ur' THEN text_value ELSE '' END, 'direction', 'rtl'),
'hi', jsonb_build_object('value', CASE WHEN lang_code = 'hi' THEN text_value ELSE '' END, 'direction', 'ltr')
);
END;
$$ LANGUAGE plpgsql;</script>
			</code>
		</pre>
			</section>

			<section data-auto-animate>
				<h4 style="color:lightgreen;font-weight:bold;">Import Strings</h4>
				<pre>
						<code style="width: 700px; margin: 0 auto; display: block; font-size: 90%;">  
							<script type="text/template">-- insert data for name branch in heritage location resource model
INSERT INTO heritage_location.name (
	tileid,
	name,
	-- name_type,
	resourceinstanceid)
(
	SELECT 
	uuid_generate_v4(),
	build_lang_json(name, 'en'),
	resourceinstanceid 
	FROM ft_hl_name
);</script>
						</code>
					</pre>
			</section>
			<section data-auto-animate>
				<h4 style="color:lightgreen;font-weight:bold">Import Concepts</h4>
				<pre>
						<code data-line-numbers="1-11|12-17|18-28" style="font-size:90%;">
							<script type="text/template">-- insert data for name branch in heritage location resource model
WITH name_type (valueid, value) AS (
	SELECT valueid, value
	FROM __arches_get_labels_for_concept_node(
		__arches_get_node_id_for_view_column(
			'heritage_location', --schema_name
			'name', --view_name
			'name_type' --column_name
		)
	)
) 
INSERT INTO heritage_location.name (
	tileid,
	name_type,
	name,
	resourceinstanceid
)
SELECT 
	uuid_generate_v4(),
	build_lang_json(name, 'en'),
	(
		SELECT valueid
		FROM name_type
		WHERE value = name_type
		LIMIT 1
	),
	resourceinstanceid 
FROM ft_hl_name;
								</script>
						</code>
					</pre>
			</section>

			<section>
				<h2 style="color:lightgreen;font-weight:bold">Import Date, EDTF, URL, Geojson-feature-collection</h2>
			</section>


			<section>
				<h4 style="color:lightgreen;font-weight:bold">Function for Concept-list</h4>
			</section>

			<section>
				<h4 style="color:lightgreen;font-weight:bold">Import Concept-list</h4>
			</section>

			<section data-auto-animate>
				<h4 style="color:lightgreen;font-weight:bold">Import Resource Instance</h4>
				<pre>
						<code data-line-numbers="1-8|9-12|13-30" style="font-size:90%;">
							<script type="text/template">-- Inserting resource relations between heritage_location and person/organisation resource model
WITH po_ids (valueid, value) AS (
	SELECT 
		resourceinstanceid, 
		mahsa_id->'en'->>'value' 
	FROM 
		person_organization.mahsa_id
)
INSERT INTO heritage_location.assessment_activity (
	tileid,
	assessor,
	resourceinstanceid )
SELECT 
	uuid_generate_v4(),
	jsonb_build_array(
		jsonb_build_object(
			'resourceId', (
				SELECT valueid
				FROM po_ids
				WHERE value = assessor_id
				LIMIT 1
			),
			'ontologyProperty', assessor_forward_ontology,
			'resourceXresourceId', '',
			'inverseOntologyProperty', assessor_inverse_ontology
		)
	),
	resourceinstanceid 
FROM 
	hl_assessment_activity;
								</script>
						</code>
					</pre>
			</section>
			<section data-auto-animate>
				<h4 style="color:lightgreen;font-weight:bold">Import Resource Instance</h4>
				<pre>
						<code style="width: 600px; margin: 0 auto; display: block; font-size: 90%;">
							<script type="text/template">[
	{
		"resourceId":"05176558-762e-4ec7-844d-d98af58cc203",
		"ontologyProperty":"P34i_was_assessed_by",
		"resourceXresourceId":"",
		"inverseOntologyProperty":"P34_concerned"
	}
]</script>
						</code>
					</pre>
			</section>

			<section data-auto-animate>
				<h4 style="color:lightgreen;font-weight:bold">Import Resource Instance List</h4>
				<pre>
						<code data-line-numbers="1-13|14-29|30-34|35-42" style="font-size:90%;">
							<script type="text/template">WITH related_ids AS (
SELECT 
	resourceinstanceid, 
	mahsa_id->'en'->>'value' AS value 
FROM 
	historic_maps.mahsa_id
UNION
SELECT 
	resourceinstanceid, 
	mahsa_id->'en'->>'value' AS value 
FROM 
	information_resource_model.mahsa_id
),
related_resources AS (
SELECT
	rr.resourceinstanceid,
	jsonb_build_object(
		'resourceId', ri.valueid,
		'ontologyProperty', rr.related_resource_forward_ontology,
		'resourceXresourceId', '',
		'inverseOntologyProperty', rr.related_resource_inverse_ontology
	) AS related_resource
FROM
	hl_resource_relationships rr
JOIN 
	related_ids ri 
ON 
	rr.related_resource_id = ri.value
)
INSERT INTO heritage_location.related_resources (
tileid,
related_resources,
resourceinstanceid
)
SELECT
uuid_generate_v4(),
jsonb_agg(related_resource),
resourceinstanceid
FROM
related_resources
GROUP BY
resourceinstanceid;</script>
						</code>
					</pre>
			</section>
			<section data-auto-animate>
				<h4 style="color:lightgreen;font-weight:bold">Import Resource Instance</h4>
				<pre>
						<code style="width: 600px; margin: 0 auto; display: block; font-size: 90%;">
							<script type="text/template">[
	{
		"resourceId":"b70f2743-ac72-4c60-91e6-071ca4582717",
		"ontologyProperty":"P70i_is_documented_in",
		"resourceXresourceId":"",
		"inverseOntologyProperty":"P70_documents"
	},
	{
		"resourceId":"9a6441ae-e2e6-453d-a073-5095c052d214",
		"ontologyProperty":"P70i_is_documented_in",
		"resourceXresourceId":"",
		"inverseOntologyProperty":"P70_documents"
	},
	{
		"resourceId":"341836a2-9f49-4603-8894-3c215c8f4108",
		"ontologyProperty":"P70i_is_documented_in",
		"resourceXresourceId":"",
		"inverseOntologyProperty":"P70_documents"
	}
]</script>
						</code>
					</pre>
			</section>





			<section>
				<h4 style="color:lightgreen;font-weight:bold">SQL Import - Advantages</h4>
			</section>

			<section>
				<h4 style="color:lightgreen;font-weight:bold">QGIS Plugin & Geojson URL</h4>
			</section>

			<section>
				<h4 style="color:lightgreen;font-weight:bold">Arches User Documentation</h4>
			</section>

			<section>
				<h4 style="color:lightgreen;font-weight:bold">Thank You!</h4>
			</section>
		</div>
	</div>

	<script src="dist/reveal.js"></script>
	<script src="plugin/notes/notes.js"></script>
	<script src="plugin/markdown/markdown.js"></script>
	<script src="plugin/highlight/highlight.js"></script>
	<script>
		// More info about initialization & config:
		// - https://revealjs.com/initialization/
		// - https://revealjs.com/config/
		Reveal.initialize({
			hash: true,

			margin: -0.2,
			slideNumber: true,
			showSlideNumber: 'all',
			center: true,
			maxHeight: 700,   // Maximum height for slides



			// Learn about plugins: https://revealjs.com/plugins/
			plugins: [RevealMarkdown, RevealHighlight, RevealNotes]
		});
	</script>
</body>

</html>